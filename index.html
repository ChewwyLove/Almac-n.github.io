<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestor de AlmacÃ©n PRO</title>
  <style>
    :root {
      --bg: #121212;
      --card: #1e1e1e;
      --accent: #00ffc3;
      --accent-hover: #00e0ad;
      --text: #f5f5f5;
      --text-muted: #b3b3b3;
      --danger: #ff4d4d;
      --danger-hover: #e60000;
      --success: #00e676;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 1rem;
    }
    h1 {
      text-align: center;
      margin-bottom: 1.5rem;
      color: var(--accent);
    }
    .container {
      max-width: 1100px;
      margin: auto;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .card {
      background: var(--card);
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 3px 15px rgba(0, 0, 0, 0.4);
      transition: 0.3s ease;
    }
    .card:hover { transform: scale(1.01); }
    .card h2 {
      margin-bottom: .8rem;
      color: var(--accent);
      font-size: 1.3rem;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
      margin-bottom: .5rem;
    }
    input, select {
      padding: .6rem;
      border-radius: 6px;
      border: 1px solid #444;
      background: #2c2c2c;
      color: var(--text);
      flex: 1;
      min-width: 140px;
    }
    .btn {
      background: var(--accent);
      color: #000;
      font-weight: bold;
      border: none;
      padding: .6rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s ease;
    }
    .btn:hover { background: var(--accent-hover); }
    .btn-danger {
      background: var(--danger);
      color: #fff;
    }
    .btn-danger:hover { background: var(--danger-hover); }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: .8rem;
    }
    th, td {
      padding: .6rem;
      text-align: center;
      border-bottom: 1px solid #333;
    }
    th { color: var(--accent); }
    tr:nth-child(even) { background: #2a2a2a; }
    .entrada { color: var(--success); font-weight: bold; }
    .retiro { color: var(--danger); font-weight: bold; }
    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    ul li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .4rem 0;
      border-bottom: 1px solid #333;
    }
    ul li span { color: var(--text-muted); }
    .status {
      margin-top: .5rem;
      font-size: .9rem;
      color: var(--text-muted);
    }
    .progress {
      height: 8px;
      background: #333;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 4px;
    }
    .progress-bar {
      height: 100%;
      background: var(--accent);
      transition: width 0.5s;
    }
    .resumen {
      display: flex;
      justify-content: space-between;
      padding-top: .8rem;
      font-size: .9rem;
      color: var(--text-muted);
    }
    @media(max-width: 700px) {
      .row { flex-direction: column; }
      table { font-size: .85rem; }
    }
  </style>
</head>
<body>
  <h1>ðŸ“¦ Gestor de AlmacÃ©n PRO</h1>
  <div class="container">
    <!-- Entrada -->
    <div class="card">
      <h2>Registrar Entrada</h2>
      <div class="row">
        <select id="itemSelectEntrada"></select>
        <input type="number" id="cantidadEntrada" placeholder="Cantidad" />
        <input type="number" id="precioEntrada" placeholder="Precio (opcional)" />
        <button class="btn" onclick="agregarRegistro()">âž• AÃ±adir</button>
      </div>
      <p class="status" id="statusEntrada"></p>
    </div>

    <!-- Retiro -->
    <div class="card">
      <h2>Retirar Stock</h2>
      <div class="row">
        <select id="itemSelectRetiro"></select>
        <input type="number" id="cantidadRetiro" placeholder="Cantidad a retirar" />
        <button class="btn btn-danger" onclick="retirarStock()">â¬‡ Retirar</button>
      </div>
      <p class="status" id="statusRetiro"></p>
    </div>

    <!-- Historial -->
    <div class="card">
      <h2>Historial de Movimientos</h2>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>Movimiento</th><th>Cantidad</th><th>Precio</th><th>Fecha</th><th>Total</th><th>AcciÃ³n</th>
            </tr>
          </thead>
          <tbody id="tablaRegistros"></tbody>
        </table>
      </div>
      <div class="resumen">
        <span>Entradas: $<span id="totalEntradas">0</span></span>
        <span>Retiros: $<span id="totalRetiros">0</span></span>
        <span>Balance: $<span id="balanceFinal">0</span></span>
      </div>
    </div>

    <!-- Inventario -->
    <div class="card">
      <h2>Inventario</h2>
      <ul id="inventario"></ul>
    </div>

    <!-- CatÃ¡logo -->
    <div class="card">
      <h2>CatÃ¡logo de Precios</h2>
      <div class="row">
        <input type="text" id="nuevoObjeto" placeholder="Nombre del objeto" />
        <input type="number" id="precioDefault" placeholder="Precio por defecto" />
        <button class="btn" onclick="agregarObjeto()">âž• AÃ±adir</button>
      </div>
      <ul id="listaObjetos"></ul>
    </div>
  </div>

  <!-- SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    window.onload = () => {
      const SUPABASE_URL = "https://vviflbcsksnecebtqady.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2aWZsYmNza3NuZWNlYnRxYWR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NjMzMzMsImV4cCI6MjA3MDAzOTMzM30.5ous_YueIifOJMhNzV6Uap1lex0Ud-d7GoaTZTJ2uX4";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      const itemSelectEntrada = document.getElementById("itemSelectEntrada");
      const itemSelectRetiro = document.getElementById("itemSelectRetiro");
      const tablaBody = document.getElementById("tablaRegistros");
      const totalEntradas = document.getElementById("totalEntradas");
      const totalRetiros = document.getElementById("totalRetiros");
      const balanceFinal = document.getElementById("balanceFinal");
      const inventario = document.getElementById("inventario");
      const listaObjetos = document.getElementById("listaObjetos");
      const statusEntrada = document.getElementById("statusEntrada");
      const statusRetiro = document.getElementById("statusRetiro");
      let catalogo = {}, registros = [];

      async function cargarDatos() {
        const { data: cat } = await supabase.from('catalogo').select('*');
        catalogo = {};
        cat.forEach(o => catalogo[o.nombre] = o.precio);

        const { data: regs } = await supabase.from('registros').select('*').order('fecha', { ascending: false });
        registros = regs;
        renderizar();
      }

      async function agregarRegistro() {
        const nombre = itemSelectEntrada.value;
        const cantidad = parseInt(document.getElementById("cantidadEntrada").value);
        const precioInput = parseFloat(document.getElementById("precioEntrada").value);
        const precio = !isNaN(precioInput) ? precioInput : catalogo[nombre];
        if (!nombre || isNaN(cantidad) || cantidad <= 0 || isNaN(precio)) return;
        const fecha = new Date().toISOString();
        const total = precio * cantidad;
        await supabase.from('registros').insert([{ nombre, cantidad, precio, fecha, total, tipo: 'entrada' }]);
        statusEntrada.textContent = "Entrada registrada âœ“";
        setTimeout(() => statusEntrada.textContent = "", 2000);
        await cargarDatos();
      }

      async function retirarStock() {
        const nombre = itemSelectRetiro.value;
        const cantidad = parseInt(document.getElementById("cantidadRetiro").value);
        if (!nombre || isNaN(cantidad) || cantidad <= 0) return;

        const disponible = registros.filter(r => r.nombre === nombre).reduce((sum, r) => sum + r.cantidad, 0);
        if (cantidad > disponible) {
          statusRetiro.textContent = "No hay suficiente stock";
          setTimeout(() => statusRetiro.textContent = "", 2000);
          return;
        }

        const precio = catalogo[nombre];
        const fecha = new Date().toISOString();
        const total = precio * -cantidad;
        await supabase.from('registros').insert([{ nombre, cantidad: -cantidad, precio, fecha, total, tipo: 'retiro' }]);
        statusRetiro.textContent = "Retiro realizado âœ“";
        setTimeout(() => statusRetiro.textContent = "", 2000);
        await cargarDatos();
      }

      async function agregarObjeto() {
        const nombre = document.getElementById("nuevoObjeto").value.trim();
        const precio = parseFloat(document.getElementById("precioDefault").value);
        if (!nombre || isNaN(precio) || precio <= 0) return;
        await supabase.from('catalogo').insert([{ nombre, precio }]);
        document.getElementById("nuevoObjeto").value = "";
        document.getElementById("precioDefault").value = "";
        await cargarDatos();
      }

      async function eliminarObjeto(nombre) {
        await supabase.from('catalogo').delete().eq('nombre', nombre);
        await cargarDatos();
      }

      async function eliminarRegistro(id) {
        await supabase.from('registros').delete().eq('id', id);
        await cargarDatos();
      }

      function renderizar() {
        // Historial
        tablaBody.innerHTML = "";
        let sumaEntradas = 0, sumaRetiros = 0;
        registros.forEach(r => {
          const tipoTexto = r.tipo === 'retiro' ? `â¬‡ Retiro: ${r.nombre}` : `â¬† Entrada: ${r.nombre}`;
          const clase = r.tipo === 'retiro' ? 'retiro' : 'entrada';
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="${clase}">${tipoTexto}</td>
            <td>${r.cantidad}</td>
            <td>$${r.precio}</td>
            <td>${new Date(r.fecha).toLocaleString()}</td>
            <td>$${r.total}</td>
            <td><button class="btn btn-danger" onclick="eliminarRegistro(${r.id})">X</button></td>`;
          tablaBody.appendChild(tr);
          if (r.tipo === 'retiro') sumaRetiros += Math.abs(r.total);
          else sumaEntradas += r.total;
        });
        totalEntradas.textContent = sumaEntradas.toFixed(2);
        totalRetiros.textContent = sumaRetiros.toFixed(2);
        balanceFinal.textContent = (sumaEntradas - sumaRetiros).toFixed(2);

        // Inventario
        inventario.innerHTML = "";
        const conteo = {};
        registros.forEach(r => conteo[r.nombre] = (conteo[r.nombre] || 0) + r.cantidad);
        const maxStock = Math.max(...Object.values(conteo), 1);
        Object.entries(conteo).forEach(([o, c]) => {
          const li = document.createElement("li");
          li.innerHTML = `
            <div>${o}: ${c} unidades</div>
            <div class="progress"><div class="progress-bar" style="width:${(c/maxStock)*100}%"></div></div>`;
          inventario.appendChild(li);
        });

        // CatÃ¡logo
        listaObjetos.innerHTML = "";
        Object.entries(catalogo).forEach(([nombre, precio]) => {
          const li = document.createElement("li");
          li.innerHTML = `${nombre} - <span>$${precio}</span> <button class="btn btn-danger" onclick="eliminarObjeto('${nombre}')">Eliminar</button>`;
          listaObjetos.appendChild(li);
        });

        // Selects
        [itemSelectEntrada, itemSelectRetiro].forEach(select => {
          select.innerHTML = "";
          Object.keys(catalogo).forEach(o => {
            const opt = document.createElement("option");
            opt.value = o;
            opt.textContent = o;
            select.appendChild(opt);
          });
        });
      }

      window.agregarRegistro = agregarRegistro;
      window.retirarStock = retirarStock;
      window.agregarObjeto = agregarObjeto;
      window.eliminarObjeto = eliminarObjeto;
      window.eliminarRegistro = eliminarRegistro;

      cargarDatos();
    };
  </script>
</body>
</html>
